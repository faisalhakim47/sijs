const MARKER='__sim__',PLACEHOLDER='__sip__',INSTANCE='__sii__',IFELSE='__siie__';function walkDomTree(a,b,{whatToShow:c=5,acceptNode:d=()=>1}={}){const e=document.createTreeWalker(a,c,{acceptNode:d},!1);let f=-1,g=!0;for(const h=()=>g=!1;e.nextNode()&&g;)f++,b(e.currentNode,f,h)}class List{constructor(){this.keys=[],this.values=[]}set(a,b){this.keys.push(a),this.values.push(b)}get(a){return this.values[this.keys.indexOf(a)]}remove(a){const b=this.keys.indexOf(a);this.keys.splice(b,1),this.values.splice(b,1)}}class Expression{constructor(a){this.nodeIndex=a}}class AttributeExpression extends Expression{constructor(a,b,c){super(a),this.attributeName=b,this.staticParts=c}}class ElementExpression extends Expression{constructor(a){super(a)}}class EventExpression extends Expression{constructor(a,b){super(a),this.eventName=b}}class ContentExpression extends Expression{constructor(a){super(a)}}class Updater{constructor(){this.numberOfPart=1}update(){}}class AttributeUpdater extends Updater{constructor(a,b){super(),this.node=a.parentElement,this.attribute=a,this.staticParts=b,this.oldValue='',this.numberOfPart=b.length-1}update(a){const b=this.staticParts.length;if(1===b&&'boolean'==typeof a[0])a[0]?this.node.removeAttributeNode(this.attribute):this.node.setAttributeNode(this.attribute);else{let c='';for(let d=0;d<b;d++)c+=this.staticParts[d]+(a[d]||'');c!==this.oldValue&&(this.attribute.nodeValue=c,this.oldValue=c)}}}class ElementUpdater extends Updater{constructor(a){super(),this.node=a,this.prevNode=a.previousSibling,this.nextNode=a.nextSibling,this.options={},a.removeAttribute(MARKER)}update(a){for(const b in a=a[0],a){const c=a[b];if('if'==b){if(c===this.options.if)continue;else c?c&&(this.nextNode.parentNode.insertBefore(this.node,this.nextNode),this.nextNode[IFELSE]=!0):(this.nextNode.parentNode.removeChild(this.node),this.nextNode[IFELSE]=!1);this.options.if=c}else if('elseIf'==b){const a=this.prevNode[IFELSE];if(c===this.options.elseIf&&a===this.options.prevIf)continue;!c||a?(this.nextNode.parentNode.removeChild(this.node),this.nextNode[IFELSE]=a):c&&(this.nextNode.parentNode.insertBefore(this.node,this.nextNode),this.nextNode[IFELSE]=!0),this.options.prevIf=a,this.options.elseIf=c}}}}class EventUpdater extends Updater{constructor(a,b){super(),this.node=a,this.eventName=b,this.oldListener=null,a.removeAttribute('on'+b)}update(a){a=a[0];a===this.oldListener||(this.oldListener&&this.node.removeEventListener(this.eventName,this.oldListener),a&&this.node.addEventListener(this.eventName,a),this.oldListener=a)}}function repeat(a,b){return new Repeat(a,b)}class Repeat{constructor(a,b){this.items=a,this.mapFn=b}update(a,b,c){const d=c.parentNode,e=this.items.length;for(let f=0;f<e;f++){const b=this.mapFn(this.items[f]),e=a.shift();e?b.render(e):d.insertBefore(b.compile().element,c)}for(let e;e=a.shift();)d.removeChild(e)}}class ContentUpdater extends Updater{constructor(a){super(),null==a.previousSibling&&a.parentNode.insertBefore(document.createTextNode(''),a),null==a.nextSibling&&a.parentNode.appendChild(document.createTextNode('')),this.prevNode=a.previousSibling,this.nextNode=a.nextSibling}get oldElements(){let a=this.prevNode.nextSibling;const b=[];for(;a!==this.nextNode;)b.push(a),a=a.nextSibling;return b}update(a){const b=a[0],c=this.prevNode.nextSibling;b instanceof LitTag?b.render(c):b instanceof Repeat?b.update(this.oldElements,this.prevNode,this.nextNode):b+''!==c.nodeValue&&(c.nodeValue=b)}}const templateCache=new List;function requestTemplate(a){const b=templateCache.get(a);if(b)return b;else{const b=new Template(a);return templateCache.set(a,b),b}}class Template{constructor(a){const b=[],c=document.createElement('template');c.innerHTML=a.join(MARKER);let d=[];walkDomTree(c.content,(a)=>{const b=document.createDocumentFragment(),c=a.nodeValue.replace(/__sim__/g,MARKER+PLACEHOLDER+MARKER).split(MARKER),e=c.length;for(let d=0;d<e;d++)b.appendChild(document.createTextNode(c[d]));d.push(()=>{a.parentNode.replaceChild(b,a)})},{whatToShow:4,acceptNode(a){return-1===a.nodeValue.indexOf(MARKER)?3:1}}),d.forEach((a)=>a()),walkDomTree(c.content,(a,c)=>{if(3===a.nodeType)return b.push(new ContentExpression(c));const d=a.attributes.length;for(let e=0;e<d;e++){const d=a.attributes.item(e);d.name===MARKER?b.push(new ElementExpression(c)):'on'===d.name.slice(0,2)?b.push(new EventExpression(c,d.name.slice(2))):-1!==d.nodeValue.indexOf(MARKER)&&b.push(new AttributeExpression(c,d.name,d.nodeValue.split(MARKER)))}},{acceptNode(a){return 3===a.nodeType?a.nodeValue===PLACEHOLDER?1:3:a.hasAttributes()?1:3}}),this.staticParts=a,this.templateElm=c,this.templateParts=b}create(){const a=[],b=document.importNode(this.templateElm.content,!0);return walkDomTree(b,(b,c)=>{const d=this.templateParts.length;for(let e=0;e<d;e++){const d=this.templateParts[e];d.nodeIndex===c&&(d instanceof ContentExpression?a.push(new ContentUpdater(b)):d instanceof AttributeExpression?a.push(new AttributeUpdater(b.attributes.getNamedItem(d.attributeName),d.staticParts)):d instanceof ElementExpression?a.push(new ElementUpdater(b)):d instanceof EventExpression&&a.push(new EventUpdater(b,d.eventName)))}},{acceptNode(a){return 3===a.nodeType?a.nodeValue===PLACEHOLDER?1:3:a.hasAttributes()?1:3}}),new TemplateInstance(this.staticParts,b.children.item(0),a)}}class TemplateInstance{constructor(a,b,c){this.staticParts=a,this.element=b,this.partUpdaters=c}update(a){for(let b,c=0,d=0;b=this.partUpdaters[d++];)b.update(a.slice(c,c+=b.numberOfPart))}}class LitTag{constructor(a,b){this.staticParts=a,this.dymanicParts=b}verify(a){return this.staticParts===a.staticParts}compile(){const a=requestTemplate(this.staticParts).create();return a.element[INSTANCE]=a,a.update(this.dymanicParts),a}render(a){const b=a[INSTANCE];b instanceof TemplateInstance&&this.verify(b)?b.update(this.dymanicParts):a.parentNode.replaceChild(this.compile().element,a)}}function html(a,...b){return new LitTag(a,b)}export{html,repeat};